-- ============================================
-- SUMP PUMP MONITOR DATABASE SCHEMA
-- ============================================

-- Readings table: stores periodic sensor data
CREATE TABLE readings (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  water_level_inches REAL,
  battery_voltage REAL,
  ac_power_on BOOLEAN,
  backup_alarm_active BOOLEAN,
  pump_running BOOLEAN,
  wifi_rssi INTEGER
);

-- Events table: stores significant events (pump cycles, alerts, etc.)
CREATE TABLE events (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  event_type TEXT NOT NULL,
  message TEXT,
  water_level_inches REAL,
  battery_voltage REAL,
  ac_power_on BOOLEAN,
  backup_alarm_active BOOLEAN
);

-- Daily summaries table: aggregated daily stats
CREATE TABLE daily_summaries (
  id BIGSERIAL PRIMARY KEY,
  date DATE UNIQUE NOT NULL,
  total_cycles INTEGER DEFAULT 0,
  total_gallons REAL DEFAULT 0,
  max_water_level REAL,
  min_battery_voltage REAL,
  power_outage_minutes INTEGER DEFAULT 0,
  backup_activations INTEGER DEFAULT 0
);

-- Configuration table: store device settings
CREATE TABLE config (
  key TEXT PRIMARY KEY,
  value TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default configuration
INSERT INTO config (key, value) VALUES
  ('high_water_threshold', '10.0'),
  ('low_battery_threshold', '11.5'),
  ('reading_interval_seconds', '60'),
  ('alert_email', ''),
  ('alert_pushover_user', ''),
  ('alert_pushover_token', ''),
  ('pit_gallons_per_inch', '1.52');

-- ============================================
-- ROW LEVEL SECURITY (RLS)
-- ============================================

-- Enable RLS on all tables
ALTER TABLE readings ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE daily_summaries ENABLE ROW LEVEL SECURITY;
ALTER TABLE config ENABLE ROW LEVEL SECURITY;

-- Create policies to allow anonymous access (for ESP32)
-- In production, you'd want more restrictive policies

CREATE POLICY "Allow anonymous insert on readings"
  ON readings FOR INSERT
  TO anon
  WITH CHECK (true);

CREATE POLICY "Allow anonymous select on readings"
  ON readings FOR SELECT
  TO anon
  USING (true);

CREATE POLICY "Allow anonymous insert on events"
  ON events FOR INSERT
  TO anon
  WITH CHECK (true);

CREATE POLICY "Allow anonymous select on events"
  ON events FOR SELECT
  TO anon
  USING (true);

CREATE POLICY "Allow anonymous all on daily_summaries"
  ON daily_summaries FOR ALL
  TO anon
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow anonymous select on config"
  ON config FOR SELECT
  TO anon
  USING (true);

-- ============================================
-- INDEXES FOR PERFORMANCE
-- ============================================

CREATE INDEX idx_readings_created_at ON readings (created_at DESC);
CREATE INDEX idx_events_created_at ON events (created_at DESC);
CREATE INDEX idx_events_type ON events (event_type);
CREATE INDEX idx_daily_summaries_date ON daily_summaries (date DESC);

-- ============================================
-- AUTOMATIC DATA CLEANUP (optional)
-- Keeps last 30 days of readings, last 1 year of events
-- ============================================

-- Function to clean old data
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
  -- Delete readings older than 30 days
  DELETE FROM readings WHERE created_at < NOW() - INTERVAL '30 days';
  
  -- Delete events older than 1 year
  DELETE FROM events WHERE created_at < NOW() - INTERVAL '1 year';
END;
$$ LANGUAGE plpgsql;